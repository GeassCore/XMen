name: xiaoman-k230-ci

on:
  push:
    tags:
      - '*'
    branches:
      - '*'
  pull_request:
  workflow_dispatch:

env:
  xuantie_toolchain: https://occ-oss-prod.oss-cn-hangzhou.aliyuncs.com/resource//1721095219235//
  toolchain_file_name: Xuantie-900-gcc-linux-6.6.0-glibc-x86_64-V2.10.1-20240712.tar.gz
  mainline_toolchain: https://github.com/riscv-collab/riscv-gnu-toolchain/releases/download/2023.10.18
  mainline_toolchain_file_name: riscv64-glibc-ubuntu-22.04-gcc-nightly-2023.10.18-nightly.tar.gz
  wget_alias: 'wget --retry-connrefused --waitretry=1 --read-timeout=20 --timeout=15 -t 0'
  ARCH: riscv
  CROSS_COMPILE: riscv64-unknown-linux-gnu-
  KBUILD_BUILD_USER: builder
  KBUILD_BUILD_HOST: revyos-riscv-builder
  KDEB_COMPRESS: xz
  KDEB_CHANGELOG_DIST: unstable
  OUTPUT: output


jobs:
  mkrootfs:
    strategy:
      fail-fast: false
      
    runs-on: ubuntu-22.04
    steps:
      - name: Create Timestamp
        run: |
              echo "BUILD_ID=$(date +%Y%m%d_%H%M%S)" >> $GITHUB_ENV
              echo "BUILD_DATE=$(date +%Y%m%d)" >> $GITHUB_ENV
      - name: Install Software
        run: |
              sudo apt install -y gdisk dosfstools build-essential autoconf automake autotools-dev ninja-build make \
                                  libncurses-dev gawk flex bison openssl libssl-dev tree \
                                  qemu-user-static binfmt-support mmdebstrap zstd libconfuse-dev mtools debian-keyring debian-archive-keyring
              ${wget_alias} https://mirror.iscas.ac.cn/revyos/revyos-addons/pool/main/r/revyos-keyring/revyos-keyring_2023.06.12_all.deb
              sudo apt install ./revyos-keyring_2023.06.12_all.deb
              
              ${wget_alias} ${mainline_toolchain}/${mainline_toolchain_file_name}
              tar -xvf ${mainline_toolchain_file_name} -C /opt
              rm -rf ${mainline_toolchain_file_name}
              export PATH="/opt/riscv/bin:$PATH"
              echo "PATH=${PATH}" >> $GITHUB_ENV
              $(CROSS_COMPILE)-gcc -v                    
      
      - name: Checkout genimage
        uses: actions/checkout@v4
        with:
          repository: pengutronix/genimage
          path: genimage
          ref: v17

      - name: Build genimage
        run: |
            pushd genimage
              ./autogen.sh
              ./configure
              make -j$(nproc)
              sudo make install
            popd
            
      - name: Checkout mkimg-k230
        uses: actions/checkout@v4
        with:
          repository: revyos/mkimg-k230
          path: k230
          ref: 2024.10.08
          
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          submodules: true
          
      - name: Build mkimg-k230
        run: |
            pushd k230
                #make revyos-release on CI
                echo "BUILD_ID=${{ env.BUILD_ID }}" >> revyos-release
                echo "BUILD_DATE=${{ env.BUILD_DATE }}" >> revyos-release
                echo "RELEASE_ID=${{ github.ref_name }}" >> revyos-release
                echo "COMMIT_ID=${{ github.sha }}" >> revyos-release
                echo "RUNNER_ID=${{ github.run_id }}" >> revyos-release

                git submodule init
                git submodule update

                # workaround for
                sed -i "s#deb http#deb [trusted=yes] http#g" ./build.sh
  
                sudo -E --preserve-env=PATH bash ./build.sh build all
                # fix permissions
                sudo chown -R $USER:$USER output
            popd
